{"ast":null,"code":"import _objectSpread from\"/Users/rdrouet/Documents/PERSONNEL/OCR/OCR-P7/mon-vieux-grimoire/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _regeneratorRuntime from\"/Users/rdrouet/Documents/PERSONNEL/OCR/OCR-P7/mon-vieux-grimoire/frontend/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/rdrouet/Documents/PERSONNEL/OCR/OCR-P7/mon-vieux-grimoire/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/rdrouet/Documents/PERSONNEL/OCR/OCR-P7/mon-vieux-grimoire/frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";/* eslint-disable react/jsx-props-no-spreading */import React,{useEffect,useMemo,useState}from'react';import{useForm}from'react-hook-form';import{useNavigate}from'react-router-dom';import{generateStarsInputs}from'../../../lib/functions';import{useFilePreview}from'../../../lib/customHooks';import addFileIMG from'../../../images/add_file.png';import styles from'./BookForm.module.css';import{updateBook,addBook}from'../../../lib/common';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";function BookForm(_ref){var _book$ratings$find;var book=_ref.book,validate=_ref.validate;var userRating=book?(_book$ratings$find=book.ratings.find(function(elt){return elt.userId===localStorage.getItem('userId');}))===null||_book$ratings$find===void 0?void 0:_book$ratings$find.grade:0;var _useState=useState(0),_useState2=_slicedToArray(_useState,2),rating=_useState2[0],setRating=_useState2[1];var navigate=useNavigate();var _useForm=useForm({defaultValues:useMemo(function(){return{title:book===null||book===void 0?void 0:book.title,author:book===null||book===void 0?void 0:book.author,year:book===null||book===void 0?void 0:book.year,genre:book===null||book===void 0?void 0:book.genre};},[book])}),register=_useForm.register,watch=_useForm.watch,formState=_useForm.formState,handleSubmit=_useForm.handleSubmit,reset=_useForm.reset;useEffect(function(){reset(book);},[book]);var file=watch(['file']);var _useFilePreview=useFilePreview(file),_useFilePreview2=_slicedToArray(_useFilePreview,1),filePreview=_useFilePreview2[0];useEffect(function(){setRating(userRating);},[userRating]);useEffect(function(){if(!book&&formState.dirtyFields.rating){var rate=document.querySelector('input[name=\"rating\"]:checked').value;setRating(parseInt(rate,10));formState.dirtyFields.rating=false;}},[formState]);var onSubmit=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(data){var newBook,updatedBook;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(book){_context.next=9;break;}if(!data.file[0]){alert('Vous devez ajouter une image');}if(!data.rating){/* eslint-disable no-param-reassign */data.rating=0;/* eslint-enable no-param-reassign */}_context.next=5;return addBook(data);case 5:newBook=_context.sent;if(!newBook.error){validate(true);}else{alert(newBook.message);}_context.next=13;break;case 9:_context.next=11;return updateBook(data,data.id);case 11:updatedBook=_context.sent;if(!updatedBook.error){navigate('/');}else{alert(updatedBook.message);}case 13:case\"end\":return _context.stop();}}},_callee);}));return function onSubmit(_x){return _ref2.apply(this,arguments);};}();var readOnlyStars=!!book;return/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit(onSubmit),className:styles.Form,children:[/*#__PURE__*/_jsx(\"input\",_objectSpread({type:\"hidden\",id:\"id\"},register('id'))),/*#__PURE__*/_jsxs(\"label\",{htmlFor:\"title\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"Titre du livre\"}),/*#__PURE__*/_jsx(\"input\",_objectSpread({type:\"text\",id:\"title\"},register('title')))]}),/*#__PURE__*/_jsxs(\"label\",{htmlFor:\"author\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"Auteur\"}),/*#__PURE__*/_jsx(\"input\",_objectSpread({type:\"text\",id:\"author\"},register('author')))]}),/*#__PURE__*/_jsxs(\"label\",{htmlFor:\"year\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"Ann\\xE9e de publication\"}),/*#__PURE__*/_jsx(\"input\",_objectSpread({type:\"text\",id:\"year\"},register('year')))]}),/*#__PURE__*/_jsxs(\"label\",{htmlFor:\"genre\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"Genre\"}),/*#__PURE__*/_jsx(\"input\",_objectSpread({type:\"text\",id:\"genre\"},register('genre')))]}),/*#__PURE__*/_jsxs(\"label\",{htmlFor:\"rate\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"Note\"}),/*#__PURE__*/_jsx(\"div\",{className:styles.Stars,children:generateStarsInputs(rating,register,readOnlyStars)})]}),/*#__PURE__*/_jsxs(\"label\",{htmlFor:\"file\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"Visuel\"}),/*#__PURE__*/_jsx(\"div\",{className:styles.AddImage,children:filePreview||book!==null&&book!==void 0&&book.imageUrl?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"img\",{src:filePreview!==null&&filePreview!==void 0?filePreview:book===null||book===void 0?void 0:book.imageUrl,alt:\"preview\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Modifier\"})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"img\",{src:addFileIMG,alt:\"Add file\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Ajouter une image\"})]})}),/*#__PURE__*/_jsx(\"input\",_objectSpread(_objectSpread({},register('file')),{},{type:\"file\",id:\"file\"}))]}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",children:\"Publier\"})]});}BookForm.defaultProps={book:null,validate:null};export default BookForm;","map":{"version":3,"names":["React","useEffect","useMemo","useState","useForm","useNavigate","generateStarsInputs","useFilePreview","addFileIMG","styles","updateBook","addBook","BookForm","book","validate","userRating","ratings","find","elt","userId","localStorage","getItem","grade","rating","setRating","navigate","defaultValues","title","author","year","genre","register","watch","formState","handleSubmit","reset","file","filePreview","dirtyFields","rate","document","querySelector","value","parseInt","onSubmit","data","alert","newBook","error","message","id","updatedBook","readOnlyStars","Form","Stars","AddImage","imageUrl","defaultProps"],"sources":["/Users/rdrouet/Documents/PERSONNEL/OCR/OCR-P7/mon-vieux-grimoire/frontend/src/components/Books/BookForm/BookForm.jsx"],"sourcesContent":["/* eslint-disable react/jsx-props-no-spreading */\nimport React, { useEffect, useMemo, useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport * as PropTypes from 'prop-types';\nimport { useNavigate } from 'react-router-dom';\nimport { generateStarsInputs } from '../../../lib/functions';\nimport { useFilePreview } from '../../../lib/customHooks';\nimport addFileIMG from '../../../images/add_file.png';\nimport styles from './BookForm.module.css';\nimport { updateBook, addBook } from '../../../lib/common';\n\nfunction BookForm({ book, validate }) {\n  const userRating = book ? book.ratings.find((elt) => elt.userId === localStorage.getItem('userId'))?.grade : 0;\n\n  const [rating, setRating] = useState(0);\n\n  const navigate = useNavigate();\n  const {\n    register, watch, formState, handleSubmit, reset,\n  } = useForm({\n    defaultValues: useMemo(() => ({\n      title: book?.title,\n      author: book?.author,\n      year: book?.year,\n      genre: book?.genre,\n    }), [book]),\n  });\n  useEffect(() => {\n    reset(book);\n  }, [book]);\n  const file = watch(['file']);\n  const [filePreview] = useFilePreview(file);\n\n  useEffect(() => {\n    setRating(userRating);\n  }, [userRating]);\n\n  useEffect(() => {\n    if (!book && formState.dirtyFields.rating) {\n      const rate = document.querySelector('input[name=\"rating\"]:checked').value;\n      setRating(parseInt(rate, 10));\n      formState.dirtyFields.rating = false;\n    }\n  }, [formState]);\n\n  const onSubmit = async (data) => {\n    // When we create a new book\n    if (!book) {\n      if (!data.file[0]) {\n        alert('Vous devez ajouter une image');\n      }\n      if (!data.rating) {\n        /* eslint-disable no-param-reassign */\n        data.rating = 0;\n        /* eslint-enable no-param-reassign */\n      }\n      const newBook = await addBook(data);\n      if (!newBook.error) {\n        validate(true);\n      } else {\n        alert(newBook.message);\n      }\n    } else {\n      const updatedBook = await updateBook(data, data.id);\n      if (!updatedBook.error) {\n        navigate('/');\n      } else {\n        alert(updatedBook.message);\n      }\n    }\n  };\n\n  const readOnlyStars = !!book;\n  return (\n    <form onSubmit={handleSubmit(onSubmit)} className={styles.Form}>\n      <input type=\"hidden\" id=\"id\" {...register('id')} />\n      <label htmlFor=\"title\">\n        <p>Titre du livre</p>\n        <input type=\"text\" id=\"title\" {...register('title')} />\n      </label>\n      <label htmlFor=\"author\">\n        <p>Auteur</p>\n        <input type=\"text\" id=\"author\" {...register('author')} />\n      </label>\n      <label htmlFor=\"year\">\n        <p>Ann√©e de publication</p>\n        <input type=\"text\" id=\"year\" {...register('year')} />\n      </label>\n      <label htmlFor=\"genre\">\n        <p>Genre</p>\n        <input type=\"text\" id=\"genre\" {...register('genre')} />\n      </label>\n      <label htmlFor=\"rate\">\n        <p>Note</p>\n        <div className={styles.Stars}>\n          {generateStarsInputs(rating, register, readOnlyStars)}\n        </div>\n      </label>\n      <label htmlFor=\"file\">\n        <p>Visuel</p>\n        <div className={styles.AddImage}>\n          {filePreview || book?.imageUrl ? (\n            <>\n              <img src={filePreview ?? book?.imageUrl} alt=\"preview\" />\n              <p>Modifier</p>\n            </>\n          ) : (\n            <>\n              <img src={addFileIMG} alt=\"Add file\" />\n              <p>Ajouter une image</p>\n            </>\n          )}\n\n        </div>\n        <input {...register('file')} type=\"file\" id=\"file\" />\n      </label>\n      <button type=\"submit\">Publier</button>\n    </form>\n  );\n}\n\nBookForm.propTypes = {\n  book: PropTypes.shape({\n    id: PropTypes.string,\n    _id: PropTypes.string,\n    userId: PropTypes.string,\n    title: PropTypes.string,\n    author: PropTypes.string,\n    year: PropTypes.number,\n    imageUrl: PropTypes.string,\n    genre: PropTypes.string,\n    ratings: PropTypes.arrayOf(PropTypes.shape({\n      userId: PropTypes.string,\n      grade: PropTypes.number,\n    })),\n    averageRating: PropTypes.number,\n  }),\n  validate: PropTypes.func,\n};\n\nBookForm.defaultProps = {\n  book: null,\n  validate: null,\n};\nexport default BookForm;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}